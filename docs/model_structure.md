# Model Structure
The model is written in Python. The model is currently available as two repositories on github:

1. PyGEM (https://github.com/drounce/PyGEM) contains the main model code.  This repository can now be installed in your environment with PyPI (https://pypi.org/project/pygem/) using "pip install pygem".

2. PyGEM-scripts (https://github.com/drounce/PyGEM-scripts) contains general scripts used to run the model (e.g., run_calibration.py, run_simulation.py) as well as the post-processing, analysis scripts (e.g., analyze_simulations.py). To use these files and run the model one must clone the github repository onto your local machine.

All input parameters are specified in the pygem_input.py file, which needs to be adjusted according to the specific datasets and model options of each user. The input file is well documented inline and [sample files](https://drive.google.com/drive/folders/13kiU00Zz2swN5OzwXiWIQTj_JLEHnDgZ) are produced to support trial runs.

## Directory structure
Currently, the model does not have a “required” set of directories. For simplicity with github, we highly recommend keeping the forked version of the code in its own directory. Furthermore, since many of the datasets that will be used for regional and global model runs are of considerable size, we encourage users to develop their own organized file structure. The code has been developed to automatically set up all file paths using relative paths from the PyGEM-Scripts directory, which is where the code is run from the command line. For example, a directory with the following subdirectories is recommended (see [sample files](https://drive.google.com/drive/folders/13kiU00Zz2swN5OzwXiWIQTj_JLEHnDgZ)):

* climate_data
  - This directory contains the reference and future climate data
* debris_data (optional)
  - This directory contains data concerning the debris thickness and sub-debris melt enhancement factors. 
* DEMs
  - This directory contains the geodetic mass balance data derived from DEM differencing that is used for calibration.
* IceThickness_Farinotti (optional)
  - This directory includes the consensus ice thickness estimates (Farinotti et al. 2019). The directory is optional unless you want to match the consensus ice thickness estimates.
* oggm_gdirs
  - This directory contains the glacier directories downloaded from OGGM. This directory will be automatically generated by the pre-processing steps from OGGM.
* Output
  - This directory contains all model output
* PyGEM-scripts
  - This directory contains scripts to run the model and process output
* RGI
  - This directory contains the RGI glacier information
* WGMS (optional)
  - This directory contains the WGMS mass balance data for validation. The directory is optional in case you prefer to validate your model with different data.

## Model code
The model code itself is heavily commented with the hope that the code is easy to follow and develop further. Broadly speaking, the current steps include:
* pre-processing any required data <em>(optional)</em>
```
python run_preprocessing_wgms_mbdata.py -mb_data_removeFA=1
```
This corrects the geodetic mass balance from [Hugonnet et al. (2021)](https://www.nature.com/articles/s41586-021-03436-z) to account for frontal ablation from Kochtitzky et al. (2022).
* setting up **pygem_input.py**
* (optional) **run_calibration_frontalablation.py** <br>This will calibrate the frontal ablation model parameter for marine-terminating glaciers; however, multiple steps are required including the following:
  - **run_calibration_frontalablation.py** using the option to merge_data
  - **run_calibration_frontalablation.py** using the option for individual calibration
  - **run_calibration_frontalablation.py** using the option to merge_calving_k
  - **run_calibration_frontalablation.py** using the option to update_mb_data
* **run_calibration.py** <br>This will calibrate model parameters based on calibration option and mass balance data. If using the Markov Chain Monte Carlo (MCMC) methods, then the first time you run this you want to use option_calibration = ‘emulator’ in your input file.
* **run_mcmc_prior.py** (optional) <br> <em>This will generate the prior distributions from the ‘emulator’ calibration that will be used for the MCMC calibration.</em>
* **run_calibration.py** (optional) <br> <em> Run this again but change the option_calibration = ‘MCMC’ to use the MCMC methods.</em>
* **run_calibration_icethickness_consensus.py** <br> <em>This will calibrate the ice viscosity (glen_a) model parameter such that the ice volume estimated using the calibrated mass balance gradients are consistent with the consensus ice volume estimates (Farinotti et al. 2019) for each RGI region.</em>
* **run_simulation.py** <br> <em>This will run the model simulation from the gcm_startyear to gcm_endyear specified in the input file.</em>
